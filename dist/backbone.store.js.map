{"version":3,"file":"backbone.store.js","sources":["../lib/model-cache.js","../lib/index.js"],"sourcesContent":["import _ from 'underscore';\n\nimport Store from './index';\n\n/*\n * Encapsulates a cache for a single model.\n */\nfunction ModelCache(Model, modelName) {\n  this.instances = {};\n  this.Model = Model;\n  this.modelName = modelName;\n  this.ModelConstructor = this._getConstructor(Model);\n}\n\n_.extend(ModelCache.prototype, {\n\n  _getConstructor(Model) {\n    const cache = this;\n\n    const ModelConstructor = function(attrs, options) {\n      return cache.get(attrs, options);\n    };\n\n    // Extend Model's static properties onto new\n    _.extend(ModelConstructor, Model);\n\n    // Backbone collections need prototype of wrapped class\n    ModelConstructor.prototype = this.Model.prototype;\n\n    return ModelConstructor;\n  },\n\n  get(attrs, options) {\n    const instanceId = attrs && attrs[this.Model.prototype.idAttribute];\n\n    // Attempt to restore a locally cached instance\n    const instance = this.instances[instanceId];\n\n    if (!instance) {\n      // If we haven't seen this instance before, start caching it\n      return this._new(attrs, options);\n    }\n\n    // Otherwise update the attributes of the cached instance\n    instance.set(attrs);\n\n    Store.trigger('update', instance, this);\n\n    return instance;\n  },\n\n  _new(attrs, options) {\n    const instance = new this.Model(attrs, options);\n\n    if (instance.isNew()) {\n      // Store the instance if we get an id after instantation\n      instance.once(`change:${ instance.idAttribute }`, this._add, this);\n    } else {\n      this._add(instance);\n    }\n\n    instance.on('destroy', this.remove, this);\n\n    return instance;\n  },\n\n  _add(instance) {\n    // If the id is already stored do not add it.\n    if (this.instances[instance.id]) return;\n\n    this.instances[instance.id] = instance;\n\n    Store.trigger('add', instance, this);\n  },\n\n  remove(instance) {\n    if (!this.instances[instance.id]) return instance;\n\n    delete this.instances[instance.id];\n\n    Store.trigger('remove', instance, this);\n\n    return instance;\n  }\n});\n\nexport default ModelCache;\n","import _ from 'underscore';\nimport Backbone from 'backbone';\n\nimport ModelCache from './model-cache';\n\nlet ModelCaches = {};\n\n/**\n * Store wrapper converts regular Backbone models into unique ones.\n *\n * Example:\n *   const StoredUser = Store(User);\n */\nfunction Store(Model, modelName = _.uniqueId('Store_')) {\n  const cache = Store.add(Model, modelName);\n\n  return cache.ModelConstructor;\n}\n\n// Static functions\n_.extend(Store, Backbone.Events, {\n\n  ModelCache,\n\n  add(Model, modelName) {\n    if (!modelName) throw 'Model name required';\n\n    if (ModelCaches[modelName]) return ModelCaches[modelName];\n\n    return ModelCaches[modelName] = new Store.ModelCache(Model, modelName);\n  },\n\n  getCache(modelName) {\n    if (!ModelCaches[modelName]) throw `Unrecognized Model: \"${ modelName }\"`;\n\n    return ModelCaches[modelName];\n  },\n\n  getAllCache() {\n    return _.clone(ModelCaches);\n  },\n\n  get(modelName) {\n    return Store.getCache(modelName).ModelConstructor;\n  },\n\n  getAll() {\n    return _.reduce(ModelCaches, (all, cache, modelName) => {\n      all[modelName] = cache.ModelConstructor;\n      return all;\n    }, {});\n  },\n\n  remove(modelName) {\n    delete ModelCaches[modelName];\n  },\n\n  removeAll() {\n    ModelCaches = {};\n  }\n});\n\nBackbone.Store = Store;\n\nexport {\n  ModelCache,\n};\n\nexport default Store;\n"],"names":["ModelCache","Model","modelName","instances","ModelConstructor","_getConstructor","_","extend","prototype","cache","attrs","options","get","instanceId","idAttribute","instance","_new","set","Store","trigger","isNew","once","_add","on","remove","id","ModelCaches","uniqueId","add","Backbone","Events","getCache","getAllCache","clone","getAll","reduce","all","removeAll"],"mappings":"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"}