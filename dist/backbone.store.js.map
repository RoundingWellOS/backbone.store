{"version":3,"file":null,"sources":["../lib/model-cache.js","../lib/index.js"],"sourcesContent":["import _ from 'underscore';\n\nimport Store from './index';\n\n/*\n * Encapsulates a cache for a single model.\n */\nfunction ModelCache(Model, modelName) {\n  this.instances = {};\n  this.Model = Model;\n  this.modelName = modelName;\n  this.modelConstructor = this._getConstructor(Model);\n}\n\n_.extend(ModelCache.prototype, {\n\n  _getConstructor(Model) {\n    const cache = this;\n\n    const modelConstructor = function(attrs, options) {\n      return cache.get(attrs, options);\n    };\n\n    // Extend Model's static properties onto new\n    _.extend(modelConstructor, Model);\n\n    // Backbone collections need prototype of wrapped class\n    modelConstructor.prototype = this.Model.prototype;\n\n    return modelConstructor;\n  },\n\n  // Override to provide a different instance index\n  // ie: return id && String(id);\n  getIndex(id) {\n    return id;\n  },\n\n  get(attrs, options) {\n    const index = this.getIndex(attrs && attrs[this.Model.prototype.idAttribute]);\n\n    // Attempt to restore a locally cached instance\n    const instance = this.instances[index];\n\n    if (!instance) {\n      // If we haven't seen this instance before, start caching it\n      return this.new(attrs, options);\n    }\n\n    // Otherwise update the attributes of the cached instance\n    instance.set(attrs, options);\n\n    Store.trigger('update', instance, this);\n\n    return instance;\n  },\n\n  new(attrs, options) {\n    const instance = new this.Model(attrs, options);\n\n    if (instance.isNew()) {\n      // Store the instance if we get an id after instantation\n      instance.once(`change:${ instance.idAttribute }`, this.add, this);\n    } else {\n      this.add(instance);\n    }\n\n    instance.on('destroy', this.remove, this);\n\n    return instance;\n  },\n\n  add(instance) {\n    const index = this.getIndex(instance.id)\n\n    // If the instance is not already stored, store it\n    if (!this.instances[index]) this.instances[index] = instance;\n\n    Store.trigger('add', instance, this);\n\n    return instance;\n  },\n\n  remove(instance) {\n    const index = this.getIndex(instance.id);\n\n    if (this.instances[index]) delete this.instances[index];\n\n    Store.trigger('remove', instance, this);\n\n    return instance;\n  }\n});\n\nexport default ModelCache;\n","import _ from 'underscore';\nimport Backbone from 'backbone';\n\nimport ModelCache from './model-cache';\n\nconst Models = {};\n\n/**\n * Store wrapper converts regular Backbone models into unique ones.\n *\n * Example:\n *   const UniqueUser = Store(User);\n */\nfunction Store(Model, modelName = _.uniqueId('Store_')) {\n  const cache = Store.add(Model, modelName);\n\n  return cache.modelConstructor;\n}\n\n// Static functions\n_.extend(Store, Backbone.Events, {\n\n  ModelCache,\n\n  get(modelName) {\n    if (!Models[modelName]) throw `Unrecognized Model: ${ modelName }`;\n\n    return Models[modelName];\n  },\n\n  add(Model, modelName) {\n    if (!modelName) throw 'Model name required!';\n\n    if (Models[modelName]) return Models[modelName];\n\n    return Models[modelName] = new Store.ModelCache(Model, modelName);\n  },\n\n  remove(modelName) {\n    delete Models[modelName];\n  },\n\n  getAll() {\n    return _.clone(Models);\n  },\n\n  removeAll() {\n    for (let modelName in Models) Store.remove(modelName);\n  }\n});\n\nBackbone.Store = Store;\n\nexport default Store;\n"],"names":["ModelCache","Model","modelName","instances","modelConstructor","_getConstructor","_","extend","prototype","cache","attrs","options","get","id","index","getIndex","idAttribute","instance","new","set","trigger","isNew","once","add","on","remove","Models","Store","uniqueId","Backbone","Events","clone"],"mappings":"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"}