{"version":3,"file":null,"sources":["../lib/model-cache.js","../lib/index.js"],"sourcesContent":["import _ from 'underscore';\n\nimport Store from './index';\n\n/*\n * Encapsulates a cache for a single model.\n */\nfunction ModelCache(Model, modelName) {\n  this.instances = {};\n  this.Model = Model;\n  this.modelName = modelName;\n  this.ModelConstructor = this._getConstructor(Model);\n}\n\n_.extend(ModelCache.prototype, {\n\n  _getConstructor(Model) {\n    const cache = this;\n\n    const ModelConstructor = function(attrs, options) {\n      return cache.get(attrs, options);\n    };\n\n    // Extend Model's static properties onto new\n    _.extend(ModelConstructor, Model);\n\n    // Backbone collections need prototype of wrapped class\n    ModelConstructor.prototype = this.Model.prototype;\n\n    return ModelConstructor;\n  },\n\n  get(attrs, options) {\n    const instanceId = attrs && attrs[this.Model.prototype.idAttribute];\n\n    // Attempt to restore a locally cached instance\n    const instance = this.instances[instanceId];\n\n    if (!instance) {\n      // If we haven't seen this instance before, start caching it\n      return this._new(attrs, options);\n    }\n\n    // Otherwise update the attributes of the cached instance\n    instance.set(attrs, options);\n\n    Store.trigger('update', instance, this);\n\n    return instance;\n  },\n\n  _new(attrs, options) {\n    const instance = new this.Model(attrs, options);\n\n    if (instance.isNew()) {\n      // Store the instance if we get an id after instantation\n      instance.once(`change:${ instance.idAttribute }`, this._add, this);\n    } else {\n      this._add(instance);\n    }\n\n    instance.on('destroy', this.remove, this);\n\n    return instance;\n  },\n\n  _add(instance) {\n    // If the id is already stored do not add it.\n    if (this.instances[instance.id]) return;\n\n    this.instances[instance.id] = instance;\n\n    Store.trigger('add', instance, this);\n  },\n\n  remove(instance) {\n    if (!this.instances[instance.id]) return instance;\n\n    delete this.instances[instance.id];\n\n    Store.trigger('remove', instance, this);\n\n    return instance;\n  }\n});\n\nexport default ModelCache;\n","import _ from 'underscore';\nimport Backbone from 'backbone';\n\nimport ModelCache from './model-cache';\n\nlet ModelCaches = {};\n\n/**\n * Store wrapper converts regular Backbone models into unique ones.\n *\n * Example:\n *   const StoredUser = Store(User);\n */\nfunction Store(Model, modelName = _.uniqueId('Store_')) {\n  const cache = Store.add(Model, modelName);\n\n  return cache.ModelConstructor;\n}\n\n// Static functions\n_.extend(Store, Backbone.Events, {\n\n  ModelCache,\n\n  add(Model, modelName) {\n    if (!modelName) throw 'Model name required';\n\n    if (ModelCaches[modelName]) return ModelCaches[modelName];\n\n    return ModelCaches[modelName] = new Store.ModelCache(Model, modelName);\n  },\n\n  getCache(modelName) {\n    if (!ModelCaches[modelName]) throw `Unrecognized Model: \"${ modelName }\"`;\n\n    return ModelCaches[modelName];\n  },\n\n  getAllCache() {\n    return _.clone(ModelCaches);\n  },\n\n  get(modelName) {\n    return Store.getCache(modelName).ModelConstructor;\n  },\n\n  getAll() {\n    return _.reduce(ModelCaches, (all, cache, modelName) => {\n      all[modelName] = cache.ModelConstructor;\n      return all;\n    }, {});\n  },\n\n  remove(modelName) {\n    delete ModelCaches[modelName];\n  },\n\n  removeAll() {\n    ModelCaches = {};\n  }\n});\n\nBackbone.Store = Store;\n\nexport default Store;\n"],"names":["ModelCache","Model","modelName","instances","ModelConstructor","_getConstructor","_","extend","prototype","cache","attrs","options","get","instanceId","idAttribute","instance","_new","set","trigger","isNew","once","_add","on","remove","id","ModelCaches","Store","uniqueId","add","Backbone","Events","clone","getCache","reduce","all"],"mappings":";;;AAIA;;;AAGA,SAASA,UAAT,CAAoBC,KAApB,EAA2BC,SAA3B,EAAsC;OAC/BC,SAAL,GAAiB,EAAjB;OACKF,KAAL,GAAaA,KAAb;OACKC,SAAL,GAAiBA,SAAjB;OACKE,gBAAL,GAAwB,KAAKC,eAAL,CAAqBJ,KAArB,CAAxB;;;AAGFK,EAAEC,MAAF,CAASP,WAAWQ,SAApB,EAA+B;iBAAA,2BAEbP,KAFa,EAEN;QACfQ,QAAQ,IAAd;;QAEML,mBAAmB,SAAnBA,gBAAmB,CAASM,KAAT,EAAgBC,OAAhB,EAAyB;aACzCF,MAAMG,GAAN,CAAUF,KAAV,EAAiBC,OAAjB,CAAP;KADF;;;MAKEJ,MAAF,CAASH,gBAAT,EAA2BH,KAA3B;;;qBAGiBO,SAAjB,GAA6B,KAAKP,KAAL,CAAWO,SAAxC;;WAEOJ,gBAAP;GAf2B;KAAA,eAkBzBM,KAlByB,EAkBlBC,OAlBkB,EAkBT;QACZE,aAAaH,SAASA,MAAM,KAAKT,KAAL,CAAWO,SAAX,CAAqBM,WAA3B,CAA5B;;;QAGMC,WAAW,KAAKZ,SAAL,CAAeU,UAAf,CAAjB;;QAEI,CAACE,QAAL,EAAe;;aAEN,KAAKC,IAAL,CAAUN,KAAV,EAAiBC,OAAjB,CAAP;;;;aAIOM,GAAT,CAAaP,KAAb,EAAoBC,OAApB;;UAEMO,OAAN,CAAc,QAAd,EAAwBH,QAAxB,EAAkC,IAAlC;;WAEOA,QAAP;GAlC2B;MAAA,gBAqCxBL,KArCwB,EAqCjBC,OArCiB,EAqCR;QACbI,WAAW,IAAI,KAAKd,KAAT,CAAeS,KAAf,EAAsBC,OAAtB,CAAjB;;QAEII,SAASI,KAAT,EAAJ,EAAsB;;eAEXC,IAAT,aAAyBL,SAASD,WAAlC,EAAkD,KAAKO,IAAvD,EAA6D,IAA7D;KAFF,MAGO;WACAA,IAAL,CAAUN,QAAV;;;aAGOO,EAAT,CAAY,SAAZ,EAAuB,KAAKC,MAA5B,EAAoC,IAApC;;WAEOR,QAAP;GAjD2B;MAAA,gBAoDxBA,QApDwB,EAoDd;;QAET,KAAKZ,SAAL,CAAeY,SAASS,EAAxB,CAAJ,EAAiC;;SAE5BrB,SAAL,CAAeY,SAASS,EAAxB,IAA8BT,QAA9B;;UAEMG,OAAN,CAAc,KAAd,EAAqBH,QAArB,EAA+B,IAA/B;GA1D2B;QAAA,kBA6DtBA,QA7DsB,EA6DZ;QACX,CAAC,KAAKZ,SAAL,CAAeY,SAASS,EAAxB,CAAL,EAAkC,OAAOT,QAAP;;WAE3B,KAAKZ,SAAL,CAAeY,SAASS,EAAxB,CAAP;;UAEMN,OAAN,CAAc,QAAd,EAAwBH,QAAxB,EAAkC,IAAlC;;WAEOA,QAAP;;CApEJ,EAwEA;;ACjFA,IAAIU,cAAc,EAAlB;;;;;;;;AAQA,SAASC,KAAT,CAAezB,KAAf,EAAwD;MAAlCC,SAAkC,uEAAtBI,EAAEqB,QAAF,CAAW,QAAX,CAAsB;;MAChDlB,QAAQiB,MAAME,GAAN,CAAU3B,KAAV,EAAiBC,SAAjB,CAAd;;SAEOO,MAAML,gBAAb;;;;AAIFE,EAAEC,MAAF,CAASmB,KAAT,EAAgBG,SAASC,MAAzB,EAAiC;;wBAAA;;KAAA,eAI3B7B,KAJ2B,EAIpBC,SAJoB,EAIT;QAChB,CAACA,SAAL,EAAgB,MAAM,qBAAN;;QAEZuB,YAAYvB,SAAZ,CAAJ,EAA4B,OAAOuB,YAAYvB,SAAZ,CAAP;;WAErBuB,YAAYvB,SAAZ,IAAyB,IAAIwB,MAAM1B,UAAV,CAAqBC,KAArB,EAA4BC,SAA5B,CAAhC;GAT6B;UAAA,oBAYtBA,SAZsB,EAYX;QACd,CAACuB,YAAYvB,SAAZ,CAAL,EAA6B,gCAA+BA,SAA/B;;WAEtBuB,YAAYvB,SAAZ,CAAP;GAf6B;aAAA,yBAkBjB;WACLI,EAAEyB,KAAF,CAAQN,WAAR,CAAP;GAnB6B;KAAA,eAsB3BvB,SAtB2B,EAsBhB;WACNwB,MAAMM,QAAN,CAAe9B,SAAf,EAA0BE,gBAAjC;GAvB6B;QAAA,oBA0BtB;WACAE,EAAE2B,MAAF,CAASR,WAAT,EAAsB,UAACS,GAAD,EAAMzB,KAAN,EAAaP,SAAb,EAA2B;UAClDA,SAAJ,IAAiBO,MAAML,gBAAvB;aACO8B,GAAP;KAFK,EAGJ,EAHI,CAAP;GA3B6B;QAAA,kBAiCxBhC,SAjCwB,EAiCb;WACTuB,YAAYvB,SAAZ,CAAP;GAlC6B;WAAA,uBAqCnB;kBACI,EAAd;;CAtCJ;;AA0CA2B,SAASH,KAAT,GAAiBA,KAAjB,CAEA;;"}